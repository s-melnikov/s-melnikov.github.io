<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LiveCodding</title>
  <style>  
    body {
      margin: 0;
      padding: 0;
    }
    #editor, #result {
      box-sizing: border-box;
      position: fixed;
      height: 100%;
      top: 0;
    }
    #result {
      border: none;
      width: 55%;
    }
    #editor {
      font: 12px/1.2 Consolas, Monaco, Menlo, 'Ubuntu Mono', monospace;
      width: 45%;
    }
    #result {
      right: 0;
    }
  </style>
</head>
<body>
  <div id="editor"></div>
  <iframe id="result"></iframe>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/ace/1.2.0/ace.js"></script>
  <script src='https://cdn.firebase.com/js/client/2.2.1/firebase.js'></script>
  <script>
    var 
      DEBOUNCE_TIME = 500,
      editor = ace.edit(document.querySelector('#editor')),
      doc = editor.getSession(),
      result = document.querySelector('#result'),
      fbref = new Firebase('https://mlnkv-live-editor.firebaseio.com'),
      recordref = null,
      recordkey = location.hash.slice(1) || null,
      userUid = localStorage.fiddle_client || randomString(16),
      isOtherUserChanges = false

    editor.setTheme('ace/theme/monokai')
    doc.setMode('ace/mode/html')
    doc.setTabSize(2)
    editor.session.setUseWorker(false)

    if (recordkey) {
      recordref = fbref.child(recordkey)      
    } else {
      recordref = fbref.push()
      location.hash = recordref.key()
      get('default.html', function(r) {
        doc.setValue(r)
      })
    }

    recordref.on('value', function(snap) {
      var value = snap.val()
      if (value && value.userUid !== userUid) {
        isOtherUserChanges = true
        var cursor = doc.selection.getCursor()
        doc.setValue(snap.val().data)
        doc.selection.moveCursorToPosition(cursor)
        editor.scrollToRow(cursor.row - 10);
      }
    })

    doc.on('change', debounce(function(e) { 
      var value = doc.getValue()
      result.contentWindow.document.open()
      result.contentWindow.document.write(value)
      result.contentWindow.document.close()
      if (isOtherUserChanges) {
        isOtherUserChanges = false
        return
      }   
      recordref.set({
        userUid: userUid, 
        data: value,
        time: Date.now()
      })
    }, DEBOUNCE_TIME))    

    function get(url, cb) {
      var r = new XMLHttpRequest()
      r.open('GET', url, true)
      r.onreadystatechange  = function() {
        if (r.status == 200) cb(r.response)
      }
      r.send()
    }

    function debounce(func, wait, immediate) {
      var timeout
      return function() {
        var context = this, args = arguments,
        later = function() {
          timeout = null
          if (!immediate) func.apply(context, args)
        },
        callNow = immediate && !timeout
        clearTimeout(timeout)
        timeout = setTimeout(later, wait)
        if (callNow) func.apply(context, args)
      }
    }

    function randomString(length) {
      var text = '', possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      for (var i = 0; i < length; i++) text += possible.charAt(Math.floor(Math.random() * possible.length));      
      return text;
    }
  </script>
</body>
</html>