<page-collections>

  <div class="page-header">
    <h2>Collections</h2>
  </div>

  <ul class="breadcrumb">
    <li class="breadcrumb-item">
      <a href="#">Home</a>
    </li>
    <li class="breadcrumb-item">
      <a href="#collections">Collections</a>
    </li>
  </ul>

  <div class="columns">
    <div class="column col-9">
      <div class="panel">
        <div class="panel-header"></div>
        <div class="panel-nav"></div>
        <div class="panel-body">
          <div class="text-right">
            <button class="btn" onclick={ showModal }>New collection</button>
          </div>
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Name</th>
                <th>Identifier</th>
                <th class="text-right">Updated</th>
                <th class="text-right">About</th>
              </tr>
            </thead>
            <tbody>
              <tr each={ collections }>
                <td><a href="#collection/{ uid }">{ title }</a></td>
                <td>{ name }</td>
                <td class="text-right">{ (new Date(updated)).toDateString() }</td>
                <td class="text-right">{ about.nickname || "[deleted]" }</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="panel-footer"></div>
      </div>
    </div>
  </div>

  <div class="modal modal-add-collection active" show={ modalShowed }>
    <div class="modal-overlay"></div>
    <form class="modal-container" onsubmit={ submitModal }>
      <div class="modal-header">
        <span class="btn btn-clear float-right" onclick={ closeModal }></span>
        <div class="modal-title">New collection</div>
      </div>
      <div class="modal-body">
        <div class="content">
          <div class="form-group { 'has-error': errors.title }">
            <label>Title</label>
            <input class="form-input" ref="title" oninput={ titleInputHandler }>
            <div class="form-input-hint">
              <div hide={ errors.title }>Collection title.</div>
              <div show={ errors.title }>{ errors.title }</div>
            </div>
          </div>
          <div class="form-group { 'has-error': errors.name }">
            <label>Slug</label>
            <input class="form-input" ref="name" oninput={ nameInputHandler }>
            <div class="form-input-hint">
              <div hide={ errors.name }>Collection name (uid).</div>
              <div show={ errors.name }>{ errors.name }</div>
            </div>
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea class="form-input" ref="description" rows="6" maxlength="500"></textarea>
            <div class="form-input-hint">Collection description (optional)</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <span class="btn btn-link btn-close" onclick={ closeModal }>Close</span>
        <button class="btn btn-primary">Submit</button>
      </div>
    </form>
  </div>

  <script>
    let
      self = this,
      stopListenTitle = false,
      errors = {}
    self.errors = errors

    showModal() {
      self.modalShowed = true
    }

    closeModal() {
      self.modalShowed = false
    }

    titleInputHandler(e) {
      if (!stopListenTitle) {
        self.refs.name.value = slugify(translit(e.target.value))
      }
    }

    nameInputHandler() {
      if (!stopListenTitle) {
        stopListenTitle = true
      }
    }

    submitModal(e) {
      e.preventDefault()
      let
        title = self.refs.title.value,
        name = self.refs.name.value,
        description = self.refs.description.value
      errors.title = ""
      errors.name = ""
      if (!title)
        errors.title = "Fill the [title] field"
      else if (title.length < 3)
        errors.title = "The [title] field must contain at least three characters"
      if (!name)
        errors.name = "Fill the [name] field"
      else if (name.length < 3)
        errors.name = "The [name] field must contain at least three characters"
      else if (!/^[a-z\d_-]+$/i.test(name))
        errors.name = "The [name] field must contain only next symbols A-Z,a-z,0-9,_,-"
      if (errors.title || errors.name) return;
      api
        .collections()
        .push({ title, name, description })
        .then(resp => {
          self.collections.push({
            title,
            name,
            description,
            uid: resp.uid,
            updated: date(),
            about: opts.app.user
          })
          self.update()
          e.target.reset()
        })
      self.closeModal()
    }

    self.on("mount", () => {
      api.collections().get().then(resp => {
        self.collections = resp.collections
        self.update()
      })
    })
  </script>
</page-collections>

