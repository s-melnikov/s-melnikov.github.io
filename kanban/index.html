<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <style>
    *, *::before, *::after {
      box-sizing: border-box;
      position: relative;
    }
    body {
      font: 15px/1.2 "Segoe UI", "Open Sans", sans-serif;
      color: #444;
    }
    .bg-turquoise {
      background-color: #1abc9c;
    }
    .bg-emerald {
      background-color: #2ecc71;
    }
    .bg-peter-river {
      background-color: #3498db;
    }
    .bg-amethyst {
      background-color: #9b59b6;
    }
    .bg-wet-asphalt {
      background-color: #34495e;
    }
    .bg-green-sea {
      background-color: #16a085;
    }
    .bg-nephritis {
      background-color: #27ae60;
    }
    .bg-belize-hole {
      background-color: #2980b9;
    }
    .bg-wisteria {
      background-color: #8e44ad;
    }
    .bg-midnight-blue {
      background-color: #2c3e50;
    }
    .bg-sun-flower {
      background-color: #f1c40f;
    }
    .bg-carrot {
      background-color: #e67e22;
    }
    .bg-alizarin {
      background-color: #e74c3c;
    }
    .bg-clouds {
      background-color: #ecf0f1;
    }
    .bg-concrete {
      background-color: #95a5a6;
    }
    .bg-orange {
      background-color: #f39c12;
    }
    .bg-pumpkin {
      background-color: #d35400;
    }
    .bg-pomegranate {
      background-color: #c0392b;
    }
    .bg-silver {
      background-color: #bdc3c7;
    }
    .bg-asbestos {
      background-color: #7f8c8d;
    }
    .boards {
      overflow: auto;
      white-space: nowrap;
      font-size: 0;
      text-align: center;
    }
    .boards .board {
      width: 320px;
      background: #f5f5f5;
      overflow: hidden;
      margin: 5px;
      display: inline-block;
      white-space: normal;
      font-size: initial;
      text-align: left;
      vertical-align: top;
    }
    .boards .board .header {
      padding: 10px 15px;
      color: #ffffff;
      text-align: center;
    }
    .boards .board .body {
      padding: 10px 7px 0;
      border-left: 1px solid #eee;
      border-right: 1px solid #eee;
    }
    .boards .board .item {
      background-color: #fff;
      padding: 10px 10px 0;
      font-size: 14px;
      border: 1px solid #eee;
    }
    .boards .board .item:not(:first-child) {
      margin-top: 7px;
    }
    .boards .board > .footer {
      padding: 10px 15px;
      color: #777777;
      text-align: center;
      border-left: 1px solid #eee;
      border-right: 1px solid #eee;
      border-bottom: 1px solid #eee;
    }
    .btn {
      display: inline-block;
      border: 1px solid #168cc3;
      padding: 7px 12px;
      color: #168cc3;
      font-size: 14px;
      cursor: pointer;
      background: none;
    }
    .btn:hover {
      background-color: rgba(0, 0, 0, .1);
    }
    .btn-link {
      border: none;
    }
    .btn-link:hover {
      background-color: transparent;
      color: #38b6f1;
    }
    .modal {
      position: fixed;
      left: 0;
      top: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.5);
    }
    .modal .content {
      position: relative;
      top: 50%;
      width: 420px;
      margin: -100px auto 0;
      background-color: #fff;
      border: 1px solid #eee;
    }
    .modal .header {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }
    .modal .body {
      padding: 15px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .modal .footer {
      padding: 10px 15px;
      text-align: right;
    }
    .modal .footer .btn {
      margin-left: 10px;
    }
    textarea {
      display: block;
      border: 1px solid #eee;
      font-family: inherit;
      color: inherit;
      width: 100%;
      height: 160px;
      margin: 0;
      padding: 10px;
    }
    .types input[type=radio] {
      display: none;
    }
    .types .type {
      display: inline-block;
      padding: 3px;
      margin-right: 5px;
      margin-top: 10px;
      cursor: pointer;
      position: relative;
    }
    .types .type .label {
      display: inline-block;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      margin-right: 5px;
      vertical-align: -2px;
      transform: scale(.5);
    }
    .types .type .title {
      color: #999;
    }
    .types input[type=radio]:checked ~ .label {
      transform: scale(1);
    }
    .types input[type=radio]:checked ~ .title {
      color: #222;
    }
    .item > .footer {
      color: #777;
      font-size: 10px;
      text-align: right;
      padding: 5px 0 3px;
    }
    .item .footer span {
      margin-left: 5px;
      cursor: pointer;
    }
    .item .footer span:hover {
      text-decoration: underline;
    }
    .item .label {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 3px;
    }
    .item .footer .time {
      font-style: italic;
      float: left;
      margin-left: 0;
      cursor: default;
    }
    .item .footer .time:hover {
      text-decoration: none;
    }
    .boards-list .board {
      display: block;
      margin: 5px 0;
    }
    .boards-list .board .title {
      display: block;
      padding: 10px 15px;
      cursor: pointer;
      color: #fff;
      font-size: 16px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .modal-move-item .content {
      width: 360px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script src="https://www.gstatic.com/firebasejs/4.6.1/firebase.js"></script>
  <script src="https://unpkg.com/hyperapp@0.15.1/dist/hyperapp.js"></script>
  <script>

    const uniqid = (length => {
      const CHARS = "-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz",
        CHARS_LENGTH = CHARS.length
      return () => {
        let chars = []
        while (length--) {
          chars.push(CHARS[Math.floor(Math.random() * CHARS_LENGTH)])
        }
        return chars.join("")
      }
    })(16)

    if (location.hash.length < 16) {
      location.hash = uniqid()
      location.reload()
    }

    firebase.initializeApp({
      databaseURL: "https://kanban-1c4b8.firebaseio.com"
    })

    let { h, app } = hyperapp,
      database = firebase.database(),
      uid = location.hash.slice(1),
      ref = database.ref(uid),
      boards = ref.child("boards"),
      items = ref.child("items"),
      types = ref.child("types"),
      root = document.querySelector("#root"),
      lastItemId = 0

    let init = (state, actions) => {
      ref.on("value", snapshot => {
        let data = snapshot.val()
        if (data == null) {
          boards.push({ id: 1, title: "To Do", color: "peter-river" })
          boards.push({ id: 2, title: "Doing", color: "carrot" })
          boards.push({ id: 3, title: "Done", color: "emerald" })
          types.push({ id: 1, title: "User Story", color: "green-sea" })
          types.push({ id: 2, title: "Defect", color: "orange" })
          types.push({ id: 3, title: "Task", color: "belize-hole" })
          types.push({ id: 4, title: "Feature", color: "pomegranate" })
        } else {
          actions.setData(data)
        }
      })
    }

    let state = {
      boards: [],
      items: [],
      types: [],
      itemEditModal: null,
      itemMoveModal: null,
      itemDeleteModal: null
    }

    let actions = {
      setData(state, actions, data) {
        let newState = {
          boards: data.boards ? Object.keys(data.boards).map(uid => {
            data.boards[uid].uid = uid
            return data.boards[uid]
          }) : [],
          items: data.items ?  Object.keys(data.items).map(uid => {
            data.items[uid].uid = uid
            return data.items[uid]
          }) : [],
          types: data.types ? Object.keys(data.types).map(uid => {
            data.types[uid].uid = uid
            return data.types[uid]
          }) : []
        }
        newState.colors = newState.types.reduce((a, b) => {
          a[b.id] = b.color
          return a
        }, {})
        return newState
      },
      itemEditModal(state, actions, data) {
        return { itemEditModal: data }
      },
      itemMoveModal(state, actions, data) {
        return { itemMoveModal: data }
      },
      itemDeleteModal(state, actions, data) {
        return { itemDeleteModal: data }
      }
    }

    let view = (state, actions) => {
      return h("div", { class: "container" },
        h("div", { class: "boards" },
          state.boards.map(board => {
            return h("div", { class: "board" },
              h("div", { class: "header bg-" + board.color },
                h("span", null, board.title)
              ),
              h("div", { class: "body" },
                state.items
                  .filter(item => item.board == board.id)
                  .map(item => {
                    return h("div", { class: "item" },
                      h("div", { class: "text" }, item.text),
                      h("div", { class: "label bg-" + state.colors[item.type] }),
                      h("div", { class: "footer" },
                        h("span", { class: "time" }, new Date(item.time).toDateString()),
                        h("span", {
                          onclick: () => actions.itemEditModal(item)
                        }, "edit"),
                        h("span", {
                          onclick: () => actions.itemMoveModal(item)
                        }, "move"),
                        h("span", {
                          onclick: () => actions.itemDeleteModal(item)
                        }, "delete")
                      )
                    )
                  })
              ),
              h("div", { class: "footer" },
                h("span", {
                  class: "btn btn-link",
                  onclick: () => actions.itemEditModal({
                    board_id: board.id
                  })
                }, "Add new card")
              )
            )
          })
        ),

        state.itemEditModal && h("div", { class: "modal" },
          h("form", {
            class: "content",
            onsubmit: event => {
              event.preventDefault()
              let text = event.target.elements.text.value.trim()
              if (text) {
                if (state.itemEditModal.uid) {
                  items.child(state.itemEditModal.uid).set({
                    text,
                    type: parseInt(event.target.elements.type.value),
                    board: state.itemEditModal.board,
                    id: state.itemEditModal.id
                  })
                } else {
                  items.push({
                    id: ++lastItemId,
                    text: text,
                    board: state.itemEditModal.board_id,
                    type: parseInt(event.target.elements.type.value),
                    time: Date.now()
                  })
                }
                event.target.reset()
                actions.itemEditModal(null)
              }
            },
            onreset: event => actions.itemEditModal(null)
          },
            h("div", { class: "header" }, state.itemEditModal.id ?
                "Edit item #ID" + state.itemEditModal.id : "Create new item"
            ),
            h("div", { class: "body" },
              h("textarea", { name: "text" }, state.itemEditModal.text || ""),
              h("div", { class: "types" },
                state.types.map((type, i) => {
                  return h("label", { class: "type" },
                    h("input", {
                      type: "radio",
                      name: "type",
                      value: type.id,
                      checked: state.itemEditModal.type ?
                        state.itemEditModal.type == type.id : !i
                    }),
                    h("span", { class: "label bg-" + type.color }),
                    h("span", { class: "title" }, type.title)
                  )
                })
              )
            ),
            h("div", { class: "footer" },
              h("button", {
                class: "btn",
                type: "reset"
              }, "Close"),
              h("button", { class: "btn" }, "Submit"),
            )
          )
        ),

        state.itemMoveModal && h("div", { class: "modal" },
          h("div", { class: "content" },
            h("div", { class: "header" }, "Move item #ID" + state.itemMoveModal.id),
            h("div", { class: "body" },
              h("div", { class: "boards-list" },
                state.boards.map(board => {
                  if (state.itemMoveModal.board == board.id) return null
                  return h("label", { class: "board" },
                    h("span", {
                      class: "title bg-" + board.color,
                      onclick: () => {
                        items.child(state.itemMoveModal.uid).set({
                          text: state.itemMoveModal.text,
                          type: state.itemMoveModal.type,
                          board: board.id,
                          id: state.itemMoveModal.id
                        })
                        actions.itemMoveModal(null)
                      },
                    }, board.title)
                  )
                })
              )
            ),
            h("div", { class: "footer" },
              h("button", {
                class: "btn",
                onclick: () => actions.itemMoveModal(null)
              }, "Close")
            )
          )
        ),

        state.itemDeleteModal && h("div", { class: "modal" },
          h("div", { class: "content" },
            h("div", { class: "header" }, "Delete item #ID" + state.itemDeleteModal.id),
            h("div", { class: "body" },
              "Are you sure to delete item #ID" + state.itemDeleteModal.id + "?"),
            h("div", { class: "footer" },
              h("button", {
                class: "btn",
                onclick: () => actions.itemDeleteModal(null)
              }, "No"),
              h("button", {
                class: "btn",
                onclick: () => {
                  items.child(state.itemDeleteModal.uid).remove()
                  actions.itemDeleteModal(null)
                }
              }, "Yes")
            )
          )
        )

      )
    }

    app({ state, actions, init, view }, root)

  </script>
</body>
</html>