<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta charset="UTF-8">
  <title>Document</title>
  <style>
    body {
      font-family: 'Fira Sans', Consolas, monospace;
      font-size: 13px;
      background-color: #f5f5f5;
      color: #444444;
    }
    .btn {
      cursor: pointer;
    }
    .btn:hover {
      opacity: .9;
    }
    .btn-primary {
      color: blue;
    }
    table {
      border-collapse: collapse;
    }
    table td, table th {
      padding: 5px;
    }
    table .current {
      background: #e3eaf1;
    }
  </style>
</head>
<body>
  <script src="https://unpkg.com/hyperapp@1.2.8/dist/hyperapp.js"></script>
  <script>
    let 
      nextTaskId = 1,
      nextTimestampId = 1;
    const
      LOCALE = 'ru-RU',
      WORK_DAY_DURATION = 8,
      { app, h } = hyperapp,
      state = {
        tasks: [],
        timestamps: []
      },
      actions = {
        startNewTask: () => ({ tasks, timestamps }) => {
          let newTask = {
            id: nextTaskId++,
            title: 'New task'
          };
          let newTimestamp = {
            id: nextTimestampId++,
            task: newTask.id,
            timestamp: dateNow()
          };
          return { 
            tasks: tasks.concat(newTask),
            timestamps: timestamps.concat(newTimestamp)
          };
        },
        startTask: id => ({ timestamps }) => {
          let newTimestamp = {
            id: nextTimestampId++,
            task: id,
            timestamp: dateNow()
          }
          return {
            timestamps: timestamps.concat(newTimestamp)
          };
        },
        update: () => true
      },
      timeSpendedString = time => {
        let s, m, h, d;
        s = time % 60;
        m = ((time = Math.floor(time / 60)) % 60);
        h = ((time = Math.floor(time / 60)) % WORK_DAY_DURATION);
        d = Math.floor(time / WORK_DAY_DURATION);
        return `${d}d ${h}h ${m}m ${s}s`;
      },
      getLastTasks = ({ tasks, timestamps }) => {
        let oldest = dateNow() - 60 * 60 * 24 * 30;        
        let lastTimestamps = timestamps.filter(timestamp => timestamp.timestamp > oldest);
        let lastTasks = tasks
          .reverse()
          .filter(task => {
            return !!lastTimestamps.find(timestamp => timestamp.task = task.id);
          })
          .map(task => {
            timestamps.map((timestamp, i) => {
              let nextTimestamp = timestamps[i + 1];
              if (timestamp.task === task.id) {
                if (!task.timeStart) {
                  task.timeStart = timestamp.timestamp;
                  task.timeSpended = 0;
                }
                if (nextTimestamp) {
                  task.timeSpended += (nextTimestamp.timestamp - timestamp.timestamp);
                } else {
                  task.current = true;
                }             
              }
            });
            return task;
          });                
        return lastTasks;
      },
      dateNow = () => Math.floor(Date.now() / 1000),
      cloneArray = array => array.slice().map(item => Object.assign({}, item)),
      TasksList = ({ tasks, startTask }) => {  
        return tasks ? tasks.map(({ id, title, timeStart, timeSpended, current }) => {
          timeStart = new Date(timeStart * 1000);
          return h('tr', { class: current ? 'current' : '' },
            h('td', {}, `${title}`),
            h('td', {}, `${timeStart.toLocaleDateString(LOCALE)} ${timeStart.toLocaleTimeString(LOCALE)}`),
            h('td', {}, timeSpendedString(timeSpended)),
            h('td', {},
              current || h('span', {
                class: 'btn btn-primary',
                onclick: event => startTask(id)
              }, 'Start')
            )
          );
        }) : null;
      },
      RootView = ({ tasks, timestamps }, { startNewTask, startTask }) => {
        let lastTasks = getLastTasks({ 
          tasks: cloneArray(tasks), 
          timestamps 
        });
        return h('div', { id: 'container' },
          h('p', { class: 'control' },
            h('span', {
              class: 'btn btn-primary',
              onclick: startNewTask
            }, 'Start New Task')
          ),
          h('table', {},
            h('thead', {},
              h('tr', {},
                h('th', {}, 'Title'),
                h('th', {}, 'Time Started'),
                h('th', {}, 'Time Spended'),
                h('th', {}, 'Actions')
              )
            ),
            h('tbody', {}, TasksList({ tasks: lastTasks, startTask }))
          )
        )
      }

    let { update } = app(state, actions, RootView, document.body);
    // setInterval(update, 1000);
  </script>
</body>
</html>
