<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta charset="UTF-8">
  <title>Document</title>
  <style>
    body {
      font-family: 'Fira Sans', Consolas, monospace;
      font-size: 13px;
      background-color: #f5f5f5;
      color: #444444;
    }
    .btn {
      cursor: pointer;
    }
    .btn:hover {
      opacity: .9;
    }
    .btn-primary {
      color: blue;
    }
    table {
      border-collapse: collapse;
    }
    table td, table th {
      padding: 5px;
    }
    table .current {
      background: #e3eaf1;
    }
  </style>
</head>
<body>
  <script src="https://unpkg.com/hyperapp@1.2.8/dist/hyperapp.js"></script>
  <script>
    const
      LOCALE = 'ru-RU',
      WORK_DAY_DURATION = 8,
      { app, h } = hyperapp,
      state = {
        tasks: [],
        events: []
      },
      actions = {
        startNewTask: () => ({ tasks, events }) => {
          let lastTask = tasks[tasks.length - 1];
          let nextTaskId = lastTask ? lastTask.id + 1 : 1;
          let lastEvent = events[events.length - 1];
          let nextEventId = lastEvent ? lastEvent.id + 1 : 1;
          tasks.push({
            id: nextTaskId,
            title: `New task #${nextTaskId}`
          });
          events.push({
            id: nextEventId,
            taskId: nextTaskId,
            timestamp: Math.floor(Date.now() / 1000)
          });
          return { tasks };
        },
        startTask: id => ({ events }) => {
          console.log(id)
          let lastEvent = events[events.length - 1];
          let nextEventId = lastEvent ? lastEvent.id + 1 : 1;
          events.push({
            id: nextEventId,
            taskId: id,
            timestamp: Math.floor(Date.now() / 1000)
          });
          return events;
        },
        update: () => true
      },
      timeSpendedString = time => {
        let s, m, h, d;
        s = time % 60;
        m = ((time = Math.floor(time / 60)) % 60);
        h = ((time = Math.floor(time / 60)) % WORK_DAY_DURATION);
        d = Math.floor(time / WORK_DAY_DURATION);
        return `${d}d ${h}h ${m}m ${s}s`;
      },
      getPreparedTasks = (tasks, events) => {
        let items = [];
        for (let i = 0, prevTimestamp, prevItem, item; i < events.length; i++) {
          let { taskId, timestamp } = events[i];
          let item = items.find(item => item.id = taskId);
          if (item) {
            items.splice(items.indexOf(item), 1);
          } else {
            item = Object.assign({timeSpended: 0}, tasks.find(({ id }) => id === taskId));
          }
          items.push(item);
          if (prevItem) {
            prevItem.timeSpended += (timestamp - prevTimestamp);
          }
          prevTimestamp = timestamp;
          prevItem = item;
        }
        return items;
      };
      TasksList = ({ history, startTask }) => {
        return history.reverse().map(({ taskId, title, timeStart, timeSpended, current }) => {
          timeStart = new Date(timeStart * 1000);
          return h('tr', { class: current ? 'current' : '' },
            h('td', {}, `${title}`),
            h('td', {}, `${timeStart.toLocaleDateString(LOCALE)} ${timeStart.toLocaleTimeString(LOCALE)}`),
            h('td', {}, timeSpendedString(timeSpended)),
            h('td', {},
              current || h('span', {
                class: 'btn btn-primary',
                onclick: event => startTask(taskId)
              }, 'Start')
            )
          );
        })
      },
      RootView = ({ tasks, events }, { startNewTask, startTask }) => {
        let preparedTasks = getPreparedTasks(tasks, events);
        return h('div', { id: 'container' },
          h('p', { class: 'control' },
            h('span', {
              class: 'btn btn-primary',
              onclick: startNewTask
            }, 'Start New Task')
          ),
          h('table', {},
            h('thead', {},
              h('tr', {},
                h('th', {}, 'Title'),
                h('th', {}, 'Time Started'),
                h('th', {}, 'Time Spended'),
                h('th', {}, 'Actions')
              )
            ),
            h('tbody', {}, TasksList({ tasks: preparedTasks, startTask }))
          )
        )
      }

    let { update } = app(state, actions, RootView, document.body);
    // setInterval(update, 1000);
  </script>
</body>
</html>
