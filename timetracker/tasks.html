<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Tasks</title>
</head>
<body>
  <app></app>
  <script src="https://unpkg.com/riot@3.12.0/riot.min.js"></script>
  <script type="text/html" id="app-template">
    <div class="cards">
      <div class="card" each="{tasksList}">
        <p class="card-body">{title}</p>
      </div>
    </div>
    <edit-form if="{editedTask}"><edit-form>
  </script>
  <script type="text/html" id="edit-form-template">
    <div class="form">
      <div class="row">
        <div class="col col-2">
          <input type="text" placeholder="key" ref="key">
        </div>
        <div class="col col-10">
          <input type="text" placeholder="title" ref="title">
        </div>
      </div>
    </div>
  </script>
  <script>
    const tpl = name => document.querySelector('#' + name + '-template').innerHTML;
    const uniqid = () => {
      let s = Date.now().toString(36);
      while (s.length < 12) s += Math.floor(Math.random() * 36).toString(36);
      return s;
    }
    const db = db_name => {
      return {
        col(col_name) {
          return {
            get(asArray) {
              let col = JSON.parse(localStorage[db_name] || '{}')[col_name];
              if (asArray) {
                return Object.keys(col).map(key => col[key]);
              }
              return col
            },
            set(item) {
              let db = JSON.parse(localStorage[db_name] || '{}');
              let col = db[col_name] || (db[col_name] = {});
              item.id = uniqid();
              col[item.id] = item;
              localStorage[db_name] = JSON.stringify(db);
              return item;
            },
            del(id) {
              let db = JSON.parse(localStorage[db_name] || '{}');
              let col = db[col_name] || (db[col_name] = {});
              delete col[id];
              localStorage[db_name] = JSON.stringify(db);
              return id;
            }
          }
        },
        reset() {
          localStorage[db_name] = '{}';
        }
      }
    }
    let tasksRef = db('test123').col('tasks');

    riot.tag('app', tpl('app'), function(opts) {
      this.tasksList = tasksRef.get(true);
      this.editedTask = null;
    })

    riot.tag('edit-form', tpl('edit-form'), function(opts) {

    })

    riot.mount('*');
  </script>
</body>
</html>